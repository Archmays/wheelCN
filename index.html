<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‰å­—å¤§è½¬ç›˜-ç»„å­—ç»„è¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å…¨å±€è®¾ç½® */
        body {
            font-family: "Xingkai SC", "KaiTi", "STKaiti", serif;
            background-color: #fdf6e3;
            background-image: radial-gradient(#eee8d5 15%, transparent 16%),
            radial-gradient(#eee8d5 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            /* é˜²æ­¢iOSç‚¹å‡»é«˜äº®å’Œé•¿æŒ‰é€‰æ‹© */
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden; /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨ */
        }

        /* è½¬ç›˜å®¹å™¨ï¼šåŠ¨æ€å°ºå¯¸ */
        .wheel-container {
            position: relative;
            /* æ ¸å¿ƒé€‚é…ï¼šæ‰‹æœºä¸Šå å®½åº¦çš„ 85%ï¼Œä½†ä¸è¶…è¿‡ 340pxï¼›ç”µè„‘ä¸Šå›ºå®š 450px */
            width: min(85vw, 340px);
            height: min(85vw, 340px); 
            margin: 0 auto;
            /* å…è®¸æ‰‹åŠ¿æ“ä½œï¼Œä½†ä¸å…è®¸æµè§ˆå™¨é»˜è®¤çš„æ»šåŠ¨å¤„ç† */
            touch-action: none; 
        }

        @media (min-width: 1024px) {
            .wheel-container {
                width: 480px;
                height: 480px;
            }
        }

        /* é’ˆå¯¹æ‰‹æœºæ¨ªå±çš„ç‰¹æ®Šå¤„ç†ï¼šç¼©å°è½¬ç›˜ä»¥é€‚åº”é«˜åº¦ */
        @media (max-height: 500px) and (orientation: landscape) {
            .wheel-container {
                width: 70vh;
                height: 70vh;
            }
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* ç¼“åŠ¨æ•ˆæœä¼˜åŒ– */
            transition: transform 3.5s cubic-bezier(0.1, 0.95, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15), inset 0 -4px 8px rgba(0,0,0,0.1);
        }

        .outer-ring {
            width: 100%;
            height: 100%;
            background: #FBD38D;
            z-index: 10;
            border: 6px solid #F6AD55;
        }

        .inner-ring {
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            background: #9AE6B4;
            z-index: 20;
            border: 6px solid #68D391;
        }

        .center-circle {
            position: absolute;
            width: 24%;
            height: 24%;
            top: 38%;
            left: 38%;
            background: #fff;
            border-radius: 50%;
            z-index: 30;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #CBD5E0;
            font-weight: bold;
            color: #718096;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            /* å­—ä½“å¤§å°é€‚é… */
            font-size: clamp(0.8rem, 3vw, 1.2rem);
        }
        
        .center-circle:active {
            transform: scale(0.95);
            background-color: #f7fafc;
        }

        .segment {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: 0 0;
            text-align: center;
            font-weight: bold;
            color: #2D3748;
            pointer-events: none;
        }

        .segment span {
            display: block;
            position: absolute;
            /* æ–‡å­—å¤§å°è‡ªé€‚åº” */
            font-size: clamp(14px, 4vw, 24px); 
            white-space: nowrap;
            /* å±…ä¸­ä¿®æ­£ */
            left: -50%; 
            width: 40px; 
            margin-left: -20px; 
            text-align: center;
        }

        .pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }
        
        .pointer-body {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 35px solid #E53E3E;
        }

        @media (min-width: 1024px) {
            .pointer-body {
                border-left: 20px solid transparent;
                border-right: 20px solid transparent;
                border-top: 45px solid #E53E3E;
            }
            .pointer { top: -25px; }
        }

        .result-card {
            animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* äº¤äº’åé¦ˆ */
        button, select {
            touch-action: manipulation; /* ä¼˜åŒ–ç‚¹å‡»å»¶è¿Ÿ */
        }
    </style>
</head>
<!-- Fix: ä½¿ç”¨ h-[100dvh] è§£å†³ iOS Safari åœ°å€æ é—®é¢˜ -->
<body class="text-gray-800 h-screen supports-[height:100dvh]:h-[100dvh] flex flex-col overflow-hidden">

    <!-- é¡¶éƒ¨æ§åˆ¶æ ï¼šç´§å‡‘å¸ƒå±€ -->
    <header class="flex-none w-full bg-white/80 backdrop-blur-sm shadow-sm z-50 px-4 py-3 flex justify-between items-center gap-2">
        <div class="flex flex-col">
            <h1 class="text-xl md:text-2xl font-bold text-red-600 tracking-wider">æ±‰å­—å¤§è½¬ç›˜</h1>
            <span id="header-grade-tag" class="text-xs text-gray-500">ä¸€å¹´çº§</span>
        </div>

        <div class="flex items-center gap-2">
            <!-- å¹´çº§é€‰æ‹©å™¨ -->
            <div class="relative">
                <select id="grade-select" onchange="changeGrade()" class="appearance-none bg-red-50 border border-red-200 text-red-800 py-1.5 pl-3 pr-8 rounded-lg text-sm font-bold focus:outline-none focus:ring-2 focus:ring-red-300 transition-all max-w-[140px] md:max-w-none truncate">
                    <option value="p1">ä¸€å¹´çº§ (åŸºç¡€å­—è¯)</option>
                    <option value="p2">äºŒå¹´çº§ (åæ—éƒ¨é¦–)</option>
                    <option value="p3">ä¸‰å¹´çº§ (å½¢å£°å­—)</option>
                    <option value="p4">å››å¹´çº§ (è¯è¯­æ­é…)</option>
                    <option value="p5">äº”å¹´çº§ (æˆè¯­å…¥é—¨)</option>
                    <option value="p6">å…­å¹´çº§ (ç»¼åˆåº”ç”¨)</option>
                    <option value="j1">åˆä¸€ (æ–‡å­¦å¸¸è¯†)</option>
                    <option value="j2">åˆäºŒ (å¤æ‚è¯æ±‡)</option>
                    <option value="j3">åˆä¸‰ (æ–‡è¨€å­—æ ¹)</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-red-500">
                    <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>

            <!-- éŸ³æ•ˆ -->
            <button id="sound-toggle" onclick="toggleSound()" class="bg-gray-100 p-2 rounded-lg text-gray-600 hover:text-red-500 active:bg-gray-200 transition-colors w-9 h-9 flex items-center justify-center">
                ğŸ”Š
            </button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºï¼šè‡ªé€‚åº”å¸ƒå±€ -->
    <main class="flex-grow flex flex-col lg:flex-row items-center justify-center gap-4 lg:gap-12 p-4 pb-8 w-full max-w-7xl mx-auto overflow-y-auto lg:overflow-hidden">
        
        <!-- å·¦ä¾§/ä¸Šæ–¹ï¼šè½¬ç›˜æ“ä½œåŒº -->
        <div class="flex flex-col items-center justify-center w-full lg:w-auto shrink-0 space-y-4">
            
            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="flex bg-gray-200/50 rounded-full p-1 shadow-inner">
                <button id="btn-mode-char" onclick="setMode('char')" class="px-6 py-1.5 rounded-full font-bold text-sm transition-all transform duration-200 shadow-sm">åæ—ç»„å­—</button>
                <button id="btn-mode-word" onclick="setMode('word')" class="px-6 py-1.5 rounded-full font-bold text-sm transition-all transform duration-200 text-gray-500">è¯è¯­æ¥é¾™</button>
            </div>

            <div class="relative">
                <!-- æ‰‹åŠ¿æç¤º -->
                <div class="absolute -right-4 top-0 md:-right-10 md:top-10 text-gray-400 text-xs md:text-sm animate-pulse flex flex-col items-center pointer-events-none z-0">
                    <span>ğŸ‘†</span>
                    <span class="writing-mode-vertical">æ»‘åŠ¨æ—‹è½¬</span>
                </div>

                <div class="wheel-container touch-none" id="wheel-touch-area">
                    <div class="pointer"><div class="pointer-body"></div></div>
                    <!-- å¤–åœˆ -->
                    <div id="outer-ring" class="ring outer-ring"></div>
                    <!-- å†…åœˆ -->
                    <div id="inner-ring" class="ring inner-ring"></div>
                    <!-- ä¸­å¿ƒ -->
                    <div class="center-circle group hover:bg-red-50" onclick="spin()">
                        <span id="center-label" class="group-hover:text-red-500 transition-colors">START</span>
                    </div>
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="flex gap-3 items-center mt-2">
                <button onclick="shuffleCurrentData()" class="bg-yellow-100 hover:bg-yellow-200 active:bg-yellow-300 text-yellow-800 px-4 py-2 rounded-full text-sm font-bold transition-colors flex items-center gap-1 shadow-sm">
                    <span>ğŸ”„</span> æ¢ä¸€æ‰¹
                </button>
                <button onclick="spin()" id="spin-btn" class="bg-red-500 hover:bg-red-600 active:scale-95 text-white px-8 py-2.5 rounded-full text-lg font-bold shadow-lg transition-all outline-none ring-2 ring-red-100">
                    å¼€å§‹æ—‹è½¬
                </button>
            </div>
        </div>

        <!-- å³ä¾§/ä¸‹æ–¹ï¼šç»“æœåŒº -->
        <!-- Fix: ç§»åŠ¨ç«¯ç§»é™¤ wrapper å›ºå®šé«˜åº¦é™åˆ¶ï¼Œè®©å†…å®¹è‡ªç„¶æ’‘å¼€ -->
        <div class="w-full max-w-md lg:w-[420px] lg:h-[480px] flex flex-col justify-center min-h-[260px] shrink-0">
            
            <!-- é»˜è®¤çŠ¶æ€ -->
            <div id="empty-state" class="text-center p-6 bg-white/60 backdrop-blur-sm rounded-2xl shadow-sm border-2 border-dashed border-red-200 h-full flex flex-col items-center justify-center">
                <span class="text-5xl lg:text-7xl mb-4 animate-bounce opacity-80">ğŸ¡</span>
                <p class="text-lg lg:text-xl font-bold text-gray-700 mb-2" id="current-grade-label">å°å­¦ä¸€å¹´çº§</p>
                <p class="text-sm text-gray-500 leading-relaxed">ç‚¹å‡»æŒ‰é’®æˆ–æ»‘åŠ¨è½¬ç›˜å¼€å§‹<br>æ¢ç´¢æ±‰å­—ä¸è¯è¯­çš„å¥¥ç§˜</p>
            </div>

            <!-- ç»“æœå¡ç‰‡ -->
            <!-- Fix: ç§»åŠ¨ç«¯ä½¿ç”¨ h-auto æ›¿ä»£ h-fullï¼Œé˜²æ­¢ flex å¸ƒå±€å‹ç¼©åº•éƒ¨å†…å®¹ -->
            <div id="result-display" class="hidden result-card bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 relative h-auto lg:h-full flex flex-col">
                <div class="bg-gradient-to-r from-red-50 to-orange-50 p-3 border-b border-red-100 flex justify-between items-center px-4">
                    <span class="text-xs text-red-400 uppercase font-bold tracking-wider">ç»“æœå±•ç¤º</span>
                    <span id="result-grade-tag" class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-md font-bold shadow-sm">ä¸€å¹´çº§</span>
                </div>
                
                <div class="p-4 lg:p-6 text-center flex-grow flex flex-col justify-center">
                    <div class="flex justify-center items-center gap-2 mb-2 text-gray-400 scale-90 lg:scale-100">
                        <span id="res-part1" class="text-3xl font-serif text-gray-600"></span>
                        <span class="text-xl">+</span>
                        <span id="res-part2" class="text-3xl font-serif text-gray-600"></span>
                        <span class="text-xl">=</span>
                    </div>

                    <!-- æ ¸å¿ƒå¤§å­— -->
                    <div id="res-main-char" class="text-7xl lg:text-8xl font-bold text-red-600 mb-2 font-serif leading-none filter drop-shadow-sm transition-all"></div>
                    <div id="res-pinyin" class="text-lg lg:text-xl text-gray-500 font-mono mb-4 bg-gray-50 inline-block mx-auto px-3 py-1 rounded-lg"></div>

                    <!-- ç»„è¯åˆ—è¡¨ -->
                    <!-- Fix: æ·»åŠ  min-h-[120px] å¼ºåˆ¶ä¿ç•™æ˜¾ç¤ºç©ºé—´ï¼Œé˜²æ­¢è¢«æŒ¤å‹ -->
                    <div class="text-left bg-orange-50/50 rounded-xl p-3 lg:p-4 border border-orange-100 flex-grow min-h-[120px] overflow-y-auto max-h-[150px] lg:max-h-none">
                        <p class="text-xs font-bold text-orange-400 mb-2 uppercase tracking-wider">è¯ç»„ä¸é‡Šä¹‰</p>
                        <ul id="res-words" class="space-y-1.5 text-gray-700 text-sm lg:text-base">
                            <!-- åˆ—è¡¨é¡¹ -->
                        </ul>
                    </div>
                </div>

                <!-- å¤±è´¥/æ— æ•ˆæç¤º -->
                <div id="error-message" class="hidden absolute inset-0 bg-white/98 z-20 flex flex-col items-center justify-center p-6 text-center animate-fadeIn">
                    <div class="text-5xl mb-4 opacity-70">ğŸƒ</div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">æœªæ”¶å½•ç»„åˆ</h3>
                    <p class="text-sm text-gray-500 mb-6 max-w-[200px] mx-auto">å½“å‰å¤§çº²ä¸­è¯¥ç»„åˆè¾ƒå°‘è§ï¼Œè¯·å°è¯•å…¶ä»–ç»„åˆã€‚</p>
                    <button onclick="closeResult()" class="px-6 py-2 bg-gray-800 hover:bg-gray-900 active:scale-95 text-white rounded-full font-bold shadow-lg text-sm transition-all">
                        å†è¯•ä¸€æ¬¡
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. æ‰©å……çš„æ•°æ®åº“ (Database) ---
        // å…³é”®ï¼šå·²ä¿®å¤ P5-J3 çš„ç»„å­—é€»è¾‘ï¼Œå¤–åœˆ(o)ç°åœ¨æ˜¯åæ—/éƒ¨ä»¶ï¼Œå†…åœˆ(i)æ˜¯éƒ¨ä»¶
        
        const fullDatabase = {
            'p1': {
                name: 'å°å­¦ä¸€å¹´çº§',
                char: [
                    { o: 'æ—¥', i: 'æœˆ', r: 'æ˜', p: 'mÃ­ng', w: ['æ˜å¤©', 'å…‰æ˜', 'æ˜ç™½'] },
                    { o: 'å°', i: 'å¤§', r: 'å°–', p: 'jiÄn', w: ['ç¬”å°–', 'å°–åˆ€', 'çœ¼å°–'] },
                    { o: 'ä¸€', i: 'ç«', r: 'ç­', p: 'miÃ¨', w: ['ç­ç«', 'æ¶ˆç­', 'ç­äº¡'] },
                    { o: 'ç”°', i: 'åŠ›', r: 'ç”·', p: 'nÃ¡n', w: ['ç”·ç”Ÿ', 'ç”·äºº', 'ç”·å¥³'] },
                    { o: 'æ‰‹', i: 'ç›®', r: 'çœ‹', p: 'kÃ n', w: ['çœ‹è§', 'çœ‹ä¹¦', 'å¥½çœ‹'] },
                    { o: 'ä¸', i: 'æ­£', r: 'æ­ª', p: 'wÄi', w: ['æ­ªæ–œ', 'æ­ªç†'] },
                    { o: 'æœ¨', i: 'æœ¨', r: 'æ—', p: 'lÃ­n', w: ['æ ‘æ—', 'æ£®æ—'] },
                    { o: 'äºº', i: 'äºº', r: 'ä»', p: 'cÃ³ng', w: ['ä»å‰', 'è·Ÿä»', 'ä»ç®€'] },
                    { o: 'å£', i: 'å', r: 'å¤', p: 'gÇ”', w: ['å¤è¯—', 'å¤ä»£', 'å¤è€'] },
                    { o: 'é—¨', i: 'å£', r: 'é—®', p: 'wÃ¨n', w: ['æé—®', 'é—®é¢˜', 'å­¦é—®'] },
                    { o: 'çˆ¶', i: 'å·´', r: 'çˆ¸', p: 'bÃ ', w: ['çˆ¸çˆ¸'] },
                    { o: 'å¥³', i: 'é©¬', r: 'å¦ˆ', p: 'mÄ', w: ['å¦ˆå¦ˆ'] },
                    { o: 'é—¨', i: 'æ—¥', r: 'é—´', p: 'jiÄn', w: ['ä¸­é—´', 'æ—¶é—´'] },
                    { o: 'ç¦¾', i: 'å£', r: 'å’Œ', p: 'hÃ©', w: ['å’Œå¹³', 'å’Œæ°”'] },
                    { o: 'æœ¨', i: 'å­', r: 'æ', p: 'lÇ', w: ['æå­', 'è¡Œæ'] }
                ],
                word: [
                    { o: 'å¤©', i: 'åœ°', r: 'å¤©åœ°', p: 'tiÄn dÃ¬', w: ['å¤©å—åœ°åŒ—', 'å¼€å¤©è¾Ÿåœ°'] },
                    { o: 'å¤§', i: 'å°', r: 'å¤§å°', p: 'dÃ  xiÇo', w: ['è¿™ä¸ªè‹¹æœå¤§å°æ­£å¥½'] },
                    { o: 'ä¸Š', i: 'ä¸‹', r: 'ä¸Šä¸‹', p: 'shÃ ng xiÃ ', w: ['ä¸Šå±±ä¸‹å±±', 'ä¸ƒä¸Šå…«ä¸‹'] },
                    { o: 'äºº', i: 'å£', r: 'äººå£', p: 'rÃ©n kÇ’u', w: ['ä¸­å›½äººå£ä¼—å¤š'] },
                    { o: 'èŠ±', i: 'è‰', r: 'èŠ±è‰', p: 'huÄ cÇo', w: ['èŠ±è‰æ ‘æœ¨'] },
                    { o: 'å±±', i: 'æ°´', r: 'å±±æ°´', p: 'shÄn shuÇ', w: ['å±±æ°´ç”»', 'æ¡‚æ—å±±æ°´'] },
                    { o: 'è¯»', i: 'ä¹¦', r: 'è¯»ä¹¦', p: 'dÃº shÅ«', w: ['è¯»ä¹¦å†™å­—'] },
                    { o: 'å†™', i: 'å­—', r: 'å†™å­—', p: 'xiÄ› zÃ¬', w: ['è®¤çœŸå†™å­—'] },
                    { o: 'å¤§', i: 'é›¨', r: 'å¤§é›¨', p: 'dÃ  yÇ”', w: ['å¤§é›¨å€¾ç›†'] },
                    { o: 'ç™½', i: 'äº‘', r: 'ç™½äº‘', p: 'bÃ¡i yÃºn', w: ['è“å¤©ç™½äº‘'] },
                    { o: 'å¤§', i: 'æ‰‹', r: 'å¤§æ‰‹', p: 'dÃ  shÇ’u', w: ['å¤§æ‰‹æ‹‰å°æ‰‹'] },
                    { o: 'ç«', i: 'å±±', r: 'ç«å±±', p: 'huÇ’ shÄn', w: ['ç«å±±çˆ†å‘'] }
                ]
            },
            'p2': {
                name: 'å°å­¦äºŒå¹´çº§',
                char: [
                    { o: 'æ°µ', i: 'é’', r: 'æ¸…', p: 'qÄ«ng', w: ['æ¸…æ°´', 'æ¸…æ´', 'æ¸…æ¾ˆ'] },
                    { o: 'æ—¥', i: 'é’', r: 'æ™´', p: 'qÃ­ng', w: ['æ™´å¤©', 'æ™´æœ—'] },
                    { o: 'ç›®', i: 'é’', r: 'ç›', p: 'jÄ«ng', w: ['çœ¼ç›', 'ç›®ä¸è½¬ç›'] },
                    { o: 'è® ', i: 'é’', r: 'è¯·', p: 'qÇng', w: ['è¯·å®¢', 'è¯·æ±‚'] },
                    { o: 'å¿„', i: 'é’', r: 'æƒ…', p: 'qÃ­ng', w: ['å¿ƒæƒ…', 'äº‹æƒ…', 'å‹æƒ…'] },
                    { o: 'è™«', i: 'é’', r: 'èœ»', p: 'qÄ«ng', w: ['èœ»èœ“'] },
                    { o: 'æ°µ', i: 'åŒ…', r: 'æ³¡', p: 'pÃ o', w: ['æ°”æ³¡', 'æ³¡æ²«'] },
                    { o: 'ç«', i: 'åŒ…', r: 'ç‚®', p: 'pÃ o', w: ['é­ç‚®', 'å¤§ç‚®'] },
                    { o: 'è¶³', i: 'åŒ…', r: 'è·‘', p: 'pÇo', w: ['è·‘æ­¥', 'é€ƒè·‘'] },
                    { o: 'æ‰Œ', i: 'åŒ…', r: 'æŠ±', p: 'bÃ o', w: ['æ‹¥æŠ±', 'æŠ±æ­‰'] },
                    { o: 'é¥£', i: 'åŒ…', r: 'é¥±', p: 'bÇo', w: ['åƒé¥±', 'é¥±æ»¡'] },
                    { o: 'æœ¨', i: 'å…¬', r: 'æ¾', p: 'sÅng', w: ['æ¾æ ‘', 'è½»æ¾'] },
                    { o: 'æœ¨', i: 'ç™½', r: 'æŸ', p: 'bÇi', w: ['æŸæ ‘', 'æŸæ²¹'] },
                    { o: 'äº»', i: 'ç™½', r: 'ä¼¯', p: 'bÃ³', w: ['ä¼¯ä¼¯', 'å¤§ä¼¯'] }
                ],
                word: [
                    { o: 'æ£®', i: 'æ—', r: 'æ£®æ—', p: 'sÄ“n lÃ­n', w: ['èŒ‚å¯†çš„æ£®æ—'] },
                    { o: 'ç¾', i: 'ä¸½', r: 'ç¾ä¸½', p: 'mÄ›i lÃ¬', w: ['ç¾ä¸½çš„é£æ™¯'] },
                    { o: 'è¾›', i: 'è‹¦', r: 'è¾›è‹¦', p: 'xÄ«n kÇ”', w: ['è¾›å‹¤åŠ³åŠ¨å¾ˆè¾›è‹¦'] },
                    { o: 'ä¸–', i: 'ç•Œ', r: 'ä¸–ç•Œ', p: 'shÃ¬ jiÃ¨', w: ['ä¸–ç•Œåœ°å›¾', 'æ–°ä¸–ç•Œ'] },
                    { o: 'æœ‹', i: 'å‹', r: 'æœ‹å‹', p: 'pÃ©ng you', w: ['å¥½æœ‹å‹'] },
                    { o: 'ä»”', i: 'ç»†', r: 'ä»”ç»†', p: 'zÇ xÃ¬', w: ['ä»”ç»†è§‚å¯Ÿ'] },
                    { o: 'æ¬¢', i: 'ä¹', r: 'æ¬¢ä¹', p: 'huÄn lÃ¨', w: ['æ¬¢ä¹çš„æµ·æ´‹'] },
                    { o: 'å‘', i: 'ç°', r: 'å‘ç°', p: 'fÄ xiÃ n', w: ['å‘ç°æ–°å¤§é™†'] },
                    { o: 'åŸ', i: 'å¸‚', r: 'åŸå¸‚', p: 'chÃ©ng shÃ¬', w: ['ç°ä»£åŸå¸‚'] },
                    { o: 'æ•…', i: 'äº‹', r: 'æ•…äº‹', p: 'gÃ¹ shi', w: ['è®²æ•…äº‹'] }
                ]
            },
            'p3': { name: 'å°å­¦ä¸‰å¹´çº§', char: [{o:'æœˆ',i:'èƒ†',r:'èƒ†',p:'dÇn',w:['èƒ†é‡']},{o:'æœˆ',i:'å·´',r:'è‚¥',p:'fÃ©i',w:['è‚¥èƒ–']},{o:'æœˆ',i:'è¦',r:'è…°',p:'yÄo',w:['è…°å¸¦']},{o:'çŠ­',i:'ç‹',r:'ç‹‚',p:'kuÃ¡ng',w:['ç–¯ç‹‚']},{o:'çŠ­',i:'è‹—',r:'çŒ«',p:'mÄo',w:['èŠ±çŒ«']},{o:'çŠ­',i:'é’',r:'çŒœ',p:'cÄi',w:['çŒœæƒ³']},{o:'è‰¹',i:'åŒ–',r:'èŠ±',p:'huÄ',w:['èŠ±æœµ']},{o:'è‰¹',i:'æ—©',r:'è‰',p:'cÇo',w:['è‰åŸ']},{o:'å®ç›–',i:'å®',r:'å®',p:'nÃ­ng',w:['å®‰å®']},{o:'ç©´',i:'å·¥',r:'ç©º',p:'kÅng',w:['å¤©ç©º']},{o:'é›¨',i:'åŠ¡',r:'é›¾',p:'wÃ¹',w:['é›¾æ°”']},{o:'é›¨',i:'åŒ…',r:'é›¹',p:'bÃ¡o',w:['å†°é›¹']}], word: [{o:'ç»§',i:'ç»­',r:'ç»§ç»­',p:'jÃ¬ xÃ¹',w:['ç»§ç»­åŠªåŠ›']},{o:'æ•´',i:'ç†',r:'æ•´ç†',p:'zhÄ›ng lÇ',w:['æ•´ç†æˆ¿é—´']},{o:'éª„',i:'å‚²',r:'éª„å‚²',p:'jiÄo Ã o',w:['è™šå¿ƒä½¿äººè¿›æ­¥']},{o:'è°¦',i:'è™š',r:'è°¦è™š',p:'qiÄn xÅ«',w:['è°¦è™šè°¨æ…']},{o:'æ‡¦',i:'å¼±',r:'æ‡¦å¼±',p:'nuÃ² ruÃ²',w:['æ€§æ ¼æ‡¦å¼±']},{o:'è’',i:'å‡‰',r:'è’å‡‰',p:'huÄng liÃ¡ng',w:['ä¸€ç‰‡è’å‡‰']},{o:'æœ´',i:'ç´ ',r:'æœ´ç´ ',p:'pÇ” sÃ¹',w:['è¡£ç€æœ´ç´ ']},{o:'ä»·',i:'å€¼',r:'ä»·å€¼',p:'jiÃ  zhÃ­',w:['å¾ˆæœ‰ä»·å€¼']},{o:'è§‚',i:'èµ',r:'è§‚èµ',p:'guÄn shÇng',w:['è§‚èµèŠ±å‰']}] },
            'p4': { name: 'å°å­¦å››å¹´çº§', char: [{o:'æ°µ',i:'æœ',r:'æ½®',p:'chÃ¡o',w:['æ½®æ¹¿']},{o:'å ¤',i:'åœŸ',r:'å ¤',p:'dÄ«',w:['å ¤å']},{o:'é˜”',i:'é—¨',r:'é˜”',p:'kuÃ²',w:['å®½é˜”']},{o:'ç›¼',i:'ç›®',r:'ç›¼',p:'pÃ n',w:['ç›¼æœ›']},{o:'æ»š',i:'æ°´',r:'æ»š',p:'gÇ”n',w:['æ»šåŠ¨']},{o:'é¡¿',i:'é¡µ',r:'é¡¿',p:'dÃ¹n',w:['åœé¡¿']},{o:'é€',i:'è±–',r:'é€',p:'zhÃº',w:['é€æ¸']},{o:'æ¸',i:'æ°´',r:'æ¸',p:'jiÃ n',w:['æ¸æ¸']},{o:'çŠ¹',i:'çŠ­',r:'çŠ¹',p:'yÃ³u',w:['çŠ¹å¦‚']},{o:'å´©',i:'å±±',r:'å´©',p:'bÄ“ng',w:['å´©æºƒ']}], word: [{o:'ç¬¼',i:'ç½©',r:'ç¬¼ç½©',p:'lÇ’ng zhÃ o',w:['è–„é›¾ç¬¼ç½©']},{o:'æ²¸',i:'è…¾',r:'æ²¸è…¾',p:'fÃ¨i tÃ©ng',w:['äººå£°é¼æ²¸']},{o:'å¥”',i:'è…¾',r:'å¥”è…¾',p:'bÄ“n tÃ©ng',w:['ä¸‡é©¬å¥”è…¾']},{o:'æ¢',i:'å¤',r:'æ¢å¤',p:'huÄ« fÃ¹',w:['æ¢å¤å¥åº·']},{o:'ç¿',i:'çƒ‚',r:'ç¿çƒ‚',p:'cÃ n lÃ n',w:['é˜³å…‰ç¿çƒ‚']},{o:'è§„',i:'å¾‹',r:'è§„å¾‹',p:'guÄ« lÇœ',w:['è‡ªç„¶è§„å¾‹']},{o:'ç¼',i:'éš™',r:'ç¼éš™',p:'fÃ¨ng xÃ¬',w:['ä»ç¼éš™ä¸­ç©¿è¿‡']},{o:'ç…§',i:'è€€',r:'ç…§è€€',p:'zhÃ o yÃ o',w:['å…‰èŠ’ç…§è€€']},{o:'é™',i:'å¯‚',r:'é™å¯‚',p:'jÃ¬ng jÃ¬',w:['é™å¯‚çš„å¤œæ™š']}] },
            // ä¿®å¤ P5 æ•°æ®ï¼šç¡®ä¿ o+i = r
            'p5': { name: 'å°å­¦äº”å¹´çº§', char: [{o:'è·¯',i:'é¸Ÿ',r:'é¹­',p:'lÃ¹',w:['ç™½é¹­']},{o:'å£',i:'è€†',r:'å—œ',p:'shÃ¬',w:['å—œå¥½']},{o:'åŒš',i:'ç”²',r:'åŒ£',p:'xiÃ¡',w:['é•œåŒ£']},{o:'å£',i:'è‚–',r:'å“¨',p:'shÃ o',w:['å“¨å…µ']},{o:'å› ',i:'å¿ƒ',r:'æ©',p:'Ä“n',w:['æ©æƒ ']},{o:'éŸ³',i:'åŒ€',r:'éŸµ',p:'yÃ¹n',w:['éŸµå‘³']},{o:'äº¡',i:'ç›®',r:'ç›²',p:'mÃ¡ng',w:['ç›²äºº']},{o:'å¶',i:'ç‰›',r:'ç‰Ÿ',p:'mÃ³u',w:['ç‰Ÿå–']}], word: [{o:'ç²¾',i:'è‡´',r:'ç²¾è‡´',p:'jÄ«ng zhÃ¬',w:['åšå·¥ç²¾è‡´']},{o:'é…',i:'åˆ',r:'é…åˆ',p:'pÃ¨i hÃ©',w:['äº’ç›¸é…åˆ']},{o:'é€‚',i:'å®œ',r:'é€‚å®œ',p:'shÃ¬ yÃ­',w:['æ°”å€™é€‚å®œ']},{o:'æ’­',i:'ç§',r:'æ’­ç§',p:'bÅ zhÃ²ng',w:['æ’­ç§å¸Œæœ›']},{o:'æµ‡',i:'æ°´',r:'æµ‡æ°´',p:'jiÄo shuÇ',w:['ç»™èŠ±æµ‡æ°´']},{o:'å©',i:'å’',r:'å©å’',p:'fÄ“n fÃ¹',w:['å¬ä»å©å’']},{o:'çˆ±',i:'æ…•',r:'çˆ±æ…•',p:'Ã i mÃ¹',w:['çˆ±æ…•è™šè£']},{o:'ä½“',i:'é¢',r:'ä½“é¢',p:'tÇ miÃ n',w:['å·¥ä½œä½“é¢']},{o:'ç³•',i:'é¥¼',r:'ç³•é¥¼',p:'gÄo bÇng',w:['ç¾å‘³çš„ç³•é¥¼']}] },
            // ä¿®å¤ P6 æ•°æ®
            'p6': { name: 'å°å­¦å…­å¹´çº§', char: [{o:'æ¯›',i:'ç‚',r:'æ¯¯',p:'tÇn',w:['åœ°æ¯¯']},{o:'é˜',i:'ä¸œ',r:'é™ˆ',p:'chÃ©n',w:['é™ˆåˆ—']},{o:'å°š',i:'è¡£',r:'è£³',p:'shang',w:['è¡£è£³']},{o:'è™«',i:'å·¥',r:'è™¹',p:'hÃ³ng',w:['å½©è™¹']},{o:'è¶³',i:'å¸',r:'è¹„',p:'tÃ­',w:['é©¬è¹„']},{o:'åºœ',i:'è‚‰',r:'è…',p:'fÇ”',w:['è±†è…']},{o:'ç¾Š',i:'ä¸‘',r:'ç¾',p:'xiÅ«',w:['å®³ç¾']},{o:'æ—¥',i:'æš´',r:'æ›',p:'pÃ¹',w:['æ›æ™’']},{o:'è® ',i:'æ™®',r:'è°±',p:'pÇ”',w:['ä¹è°±']}], word: [{o:'æ¸²',i:'æŸ“',r:'æ¸²æŸ“',p:'xuÃ n rÇn',w:['æ¸²æŸ“æ°”æ°›']},{o:'å‹¾',i:'å‹’',r:'å‹¾å‹’',p:'gÅu lÃ¨',w:['å‹¾å‹’è½®å»“']},{o:'æƒŠ',i:'å¹',r:'æƒŠå¹',p:'jÄ«ng tÃ n',w:['ä»¤äººæƒŠå¹']},{o:'å›',i:'å‘³',r:'å›å‘³',p:'huÃ­ wÃ¨i',w:['å›å‘³æ— ç©·']},{o:'ä¹',i:'è¶£',r:'ä¹è¶£',p:'lÃ¨ qÃ¹',w:['äº«å—ä¹è¶£']},{o:'æ´’',i:'è„±',r:'æ´’è„±',p:'sÇ tuÅ',w:['ä¸¾æ­¢æ´’è„±']},{o:'è¿‚',i:'å›',r:'è¿‚å›',p:'yÅ« huÃ­',w:['è¿‚å›æˆ˜æœ¯']},{o:'æ‹˜',i:'æŸ',r:'æ‹˜æŸ',p:'jÅ« shÃ¹',w:['æ˜¾å¾—å¾ˆæ‹˜æŸ']},{o:'å¹½',i:'é›…',r:'å¹½é›…',p:'yÅu yÇ',w:['ç¯å¢ƒå¹½é›…']}] },
            // ä¿®å¤ J1 æ•°æ®
            'j1': { name: 'åˆä¸­ä¸€å¹´çº§', char: [{o:'é…‰',i:'äº‘',r:'é…',p:'yÃ¹n',w:['é…é…¿']},{o:'é…‰',i:'è‰¯',r:'é…¿',p:'niÃ ng',w:['é…¿é€ ']},{o:'ç©´',i:'æœ',r:'çª ',p:'kÄ“',w:['çª å·¢']},{o:'å£',i:'ä¾¯',r:'å–‰',p:'hÃ³u',w:['å–‰å’™']},{o:'å£',i:'é¾™',r:'å’™',p:'lÃ³ng',w:['å–‰å’™']},{o:'è‰¹',i:'ä½',r:'è…',p:'lÃ¬',w:['è…ä¸´']},{o:'æ–‡',i:'å£',r:'å',p:'lÃ¬n',w:['åå•¬']},{o:'è‰¯',i:'æœˆ',r:'æœ—',p:'lÇng',w:['æœ—æ¶¦']},{o:'æ°µ',i:'æ',r:'æ·…',p:'xÄ«',w:['æ·…æ²¥']},{o:'æ°µ',i:'åŠ›',r:'æ²¥',p:'lÃ¬',w:['æ²¥é’']}], word: [{o:'é…',i:'é…¿',r:'é…é…¿',p:'yÃ¹n niÃ ng',w:['é…é…¿å·²ä¹…']},{o:'å–',i:'å¼„',r:'å–å¼„',p:'mÃ i nong',w:['å–å¼„æ‰å']},{o:'å˜¹',i:'äº®',r:'å˜¹äº®',p:'liÃ¡o liÃ ng',w:['æ­Œå£°å˜¹äº®']},{o:'é»„',i:'æ™•',r:'é»„æ™•',p:'huÃ¡ng yÃ¹n',w:['ç¯å…‰é»„æ™•']},{o:'çƒ˜',i:'æ‰˜',r:'çƒ˜æ‰˜',p:'hÅng tuÅ',w:['çƒ˜æ‰˜æ°›å›´']},{o:'é™',i:'é»˜',r:'é™é»˜',p:'jÃ¬ng mÃ²',w:['å…¨åœºé™é»˜']},{o:'é£',i:'ç­',r:'é£ç­',p:'fÄ“ng zheng',w:['æ”¾é£ç­']},{o:'æŠ–',i:'æ“',r:'æŠ–æ“',p:'dÇ’u sÇ’u',w:['ç²¾ç¥æŠ–æ“']},{o:'å¥',i:'å£®',r:'å¥å£®',p:'jiÃ n zhuÃ ng',w:['èº«ä½“å¥å£®']}] },
            // ä¿®å¤ J2 æ•°æ®
            'j2': { name: 'åˆä¸­äºŒå¹´çº§', char: [{o:'æ°µ',i:'è´µ',r:'æºƒ',p:'kuÃ¬',w:['æºƒé€€']},{o:'æ°µ',i:'ä¸–',r:'æ³„',p:'xiÃ¨',w:['æ³„æ°”']},{o:'å”',i:'ç›®',r:'ç£',p:'dÅ«',w:['ç£æˆ˜']},{o:'å°§',i:'ç¾½',r:'ç¿˜',p:'qiÃ¡o',w:['ç¿˜é¦–']},{o:'é…‰',i:'å‘Š',r:'é…·',p:'kÃ¹',w:['é…·ä¼¼']},{o:'å¿„',i:'è‚–',r:'æ‚„',p:'qiÇo',w:['æ‚„ç„¶']},{o:'å¥³',i:'é—²',r:'å¨´',p:'xiÃ¡n',w:['å¨´ç†Ÿ']},{o:'å¿„',i:'è§£',r:'æ‡ˆ',p:'xiÃ¨',w:['æ¾æ‡ˆ']},{o:'ç«',i:'å–¿',r:'ç‡¥',p:'zÃ o',w:['ç‡¥çƒ­']},{o:'æ­¹',i:'å•',r:'æ®š',p:'dÄn',w:['æ®šç²¾ç«­è™‘']}], word: [{o:'æ‘§',i:'æ¯',r:'æ‘§æ¯',p:'cuÄ« kÅ«',w:['æ‘§æ¯æ‹‰æœ½']},{o:'æ‹‰',i:'æœ½',r:'æ‹‰æœ½',p:'lÄ xiÇ”',w:['æ‘§æ¯æ‹‰æœ½']},{o:'é”',i:'ä¸',r:'é”ä¸',p:'ruÃ¬ bÃ¹',w:['é”ä¸å¯å½“']},{o:'å¯',i:'å½“',r:'å¯å½“',p:'kÄ› dÄng',w:['é”ä¸å¯å½“']},{o:'å¨´',i:'ç†Ÿ',r:'å¨´ç†Ÿ',p:'xiÃ¡n shÃº',w:['æŠ€è‰ºå¨´ç†Ÿ']},{o:'ä¸€',i:'ä¸',r:'ä¸€ä¸',p:'yÄ« sÄ«',w:['ä¸€ä¸ä¸è‹Ÿ']},{o:'ä¸',i:'è‹Ÿ',r:'ä¸è‹Ÿ',p:'bÃ¹ gÇ’u',w:['ä¸€ä¸ä¸è‹Ÿ']},{o:'æƒŠ',i:'å¿ƒ',r:'æƒŠå¿ƒ',p:'jÄ«ng xÄ«n',w:['æƒŠå¿ƒåŠ¨é­„']},{o:'åŠ¨',i:'é­„',r:'åŠ¨é­„',p:'dÃ²ng pÃ²',w:['æƒŠå¿ƒåŠ¨é­„']}] },
            // ä¿®å¤ J3 æ•°æ®
            'j3': { name: 'åˆä¸­ä¸‰å¹´çº§', char: [{o:'å¥³',i:'å¤­',r:'å¦–',p:'yÄo',w:['å¦–å¨†']},{o:'å¥³',i:'å°§',r:'å¨†',p:'rÃ¡o',w:['å¦–å¨†']},{o:'æ‰Œ',i:'æ–¤',r:'æŠ˜',p:'zhÃ©',w:['æŠ˜è…°']},{o:'æ°µ',i:'å¹²',r:'æ±—',p:'hÃ¡n',w:['å¯æ±—']},{o:'é’…',i:'å¸›',r:'é”¦',p:'jÇn',w:['é”¦ç»£']},{o:'å¥³',i:'å•',r:'å©µ',p:'chÃ¡n',w:['å©µå¨Ÿ']},{o:'å£',i:'äºš',r:'å“‘',p:'yÇ',w:['å“‘å·´']},{o:'å›—',i:'ç”«',r:'åœƒ',p:'pÇ”',w:['è‹—åœƒ']},{o:'é’…',i:'å›º',r:'é”¢',p:'gÃ¹',w:['ç¦é”¢']}], word: [{o:'å¦–',i:'å¨†',r:'å¦–å¨†',p:'yÄo rÃ¡o',w:['åˆ†å¤–å¦–å¨†']},{o:'é£',i:'éªš',r:'é£éªš',p:'fÄ“ng sÄo',w:['ç•¥è¾“é£éªš']},{o:'å¤©',i:'éª„',r:'å¤©éª„',p:'tiÄn jiÄo',w:['ä¸€ä»£å¤©éª„']},{o:'é£',i:'æµ',r:'é£æµ',p:'fÄ“ng liÃº',w:['æ•°é£æµäººç‰©']},{o:'ç¦',i:'é”¢',r:'ç¦é”¢',p:'jÃ¬n gÃ¹',w:['æ€æƒ³ç¦é”¢']},{o:'é™',i:'è°§',r:'é™è°§',p:'jÃ¬ng mÃ¬',w:['ç¯å¢ƒé™è°§']},{o:'å–§',i:'åš·',r:'å–§åš·',p:'xuÄn rÇng',w:['å¤§å£°å–§åš·']},{o:'é¢¤',i:'åŠ¨',r:'é¢¤åŠ¨',p:'chÃ n dÃ²ng',w:['å¾®å¾®é¢¤åŠ¨']},{o:'æ·±',i:'é‚ƒ',r:'æ·±é‚ƒ',p:'shÄ“n suÃ¬',w:['ç›®å…‰æ·±é‚ƒ']}] }
        };

        // --- 2. çŠ¶æ€ä¸å˜é‡ ---
        let currentMode = 'char';
        let currentGrade = 'p1';
        let isSpinning = false;
        let outerRotation = 0;
        let innerRotation = 0;
        let spinInterval = null;
        let activeData = { outer: [], inner: [], mapping: {} };

        const outerRingEl = document.getElementById('outer-ring');
        const innerRingEl = document.getElementById('inner-ring');
        const resultDisplayEl = document.getElementById('result-display');
        const emptyStateEl = document.getElementById('empty-state');
        const btnChar = document.getElementById('btn-mode-char');
        const btnWord = document.getElementById('btn-mode-word');
        const gradeSelect = document.getElementById('grade-select');
        const currentGradeLabel = document.getElementById('current-grade-label');
        const headerGradeTag = document.getElementById('header-grade-tag');
        const resultGradeTag = document.getElementById('result-grade-tag');

        // --- 3. éŸ³æ•ˆç®¡ç†å™¨ (Web Audio API) ---
        const SoundManager = {
            ctx: null,
            isMuted: false,
            init: function() {
                if (!this.ctx) {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playClick: function() {
                if (this.isMuted || !this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, t);
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.05);
                gain.gain.setValueAtTime(0.2, t); // éŸ³é‡ç¨å°
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(t);
                osc.stop(t + 0.06);
            },
            playWin: function() {
                if (this.isMuted || !this.ctx) return;
                const t = this.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.1, t + 0.1 + i*0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 1.2);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(t);
                    osc.stop(t + 1.2);
                });
            },
            playFail: function() {
                if (this.isMuted || !this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.linearRampToValueAtTime(100, t + 0.3);
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(t);
                osc.stop(t + 0.3);
            }
        };

        function toggleSound() {
            SoundManager.isMuted = !SoundManager.isMuted;
            document.getElementById('sound-toggle').innerText = SoundManager.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            if (!SoundManager.isMuted) SoundManager.init();
        }

        // --- 4. æ ¸å¿ƒé€»è¾‘ ---

        function shuffleCurrentData() {
            const sourceArray = fullDatabase[currentGrade][currentMode];
            const shuffled = [...sourceArray].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 12);

            activeData.outer = [];
            activeData.inner = [];
            activeData.mapping = {};

            selected.forEach(item => {
                activeData.outer.push(item.o);
                activeData.inner.push(item.i);
                activeData.mapping[`${item.o}+${item.i}`] = item;
            });

            renderRings();
            
            const dbName = fullDatabase[currentGrade].name;
            currentGradeLabel.innerText = dbName;
            headerGradeTag.innerText = dbName.split(' ')[1] || dbName;
            resultGradeTag.innerText = dbName.replace(/å°å­¦|åˆä¸­/g, '');
            
            closeResult();
        }

        // æ ¸å¿ƒæ¸²æŸ“ï¼šåŠ¨æ€è®¡ç®—æ–‡å­—ä½ç½®
        function renderRings() {
            // è·å–å®¹å™¨å®é™…å®½åº¦ä»¥è®¡ç®—æ–‡å­—åç§»é‡
            const container = document.querySelector('.wheel-container');
            const width = container.offsetWidth;
            const radius = width / 2;
            
            // å¤–åœˆæ–‡å­—åç§»åŠå¾„ (çº¦ 85%)ï¼Œå†…åœˆ (çº¦ 55%)
            // å‡å»ä¸€å®šå€¼ä¿®æ­£æ–‡å­—å‚ç›´å±…ä¸­
            const outerDist = radius * 0.82;
            const innerDist = radius * 0.52;

            renderRing(outerRingEl, activeData.outer, outerDist);
            renderRing(innerRingEl, activeData.inner, innerDist);
        }

        function renderRing(element, items, distance) {
            element.innerHTML = '';
            const count = items.length;
            const anglePerItem = 360 / count;

            items.forEach((item, index) => {
                const rotation = index * anglePerItem;
                const segment = document.createElement('div');
                segment.className = 'segment';
                segment.style.transform = `rotate(${rotation}deg)`;
                
                const span = document.createElement('span');
                span.innerText = item;
                // åå‘æ—‹è½¬æ–‡å­—ä½¿å…¶å‚ç›´ï¼Œå¹¶å‘ä¸Šæ¨é€åˆ°æŒ‡å®šè·ç¦»
                span.style.transform = `translateY(-${distance}px) rotate(0deg)`;

                segment.appendChild(span);
                element.appendChild(segment);
            });
        }

        function initWheel() {
            shuffleCurrentData();
        }

        function changeGrade() {
            if (isSpinning) return;
            currentGrade = gradeSelect.value;
            initWheel();
        }

        function setMode(mode) {
            if (isSpinning) return;
            currentMode = mode;
            
            // æŒ‰é’®æ ·å¼
            const activeClass = "bg-white text-gray-800 shadow-sm transform scale-105";
            const inactiveClass = "text-gray-500 hover:text-gray-700";
            
            const btnColor = mode === 'word' ? 'text-blue-600' : 'text-red-600';
            const spinBtn = document.getElementById('spin-btn');
            
            if (mode === 'char') {
                btnChar.className = `px-6 py-1.5 rounded-full font-bold text-sm transition-all duration-200 ${activeClass} text-red-600`;
                btnWord.className = `px-6 py-1.5 rounded-full font-bold text-sm transition-all duration-200 ${inactiveClass}`;
                spinBtn.className = spinBtn.className.replace(/blue/g, 'red');
            } else {
                btnWord.className = `px-6 py-1.5 rounded-full font-bold text-sm transition-all duration-200 ${activeClass} text-blue-600`;
                btnChar.className = `px-6 py-1.5 rounded-full font-bold text-sm transition-all duration-200 ${inactiveClass}`;
                spinBtn.className = spinBtn.className.replace(/red/g, 'blue');
            }
            initWheel();
        }

        // --- 5. äº¤äº’é€»è¾‘ (æ—‹è½¬ + è§¦æ‘¸) ---

        function spin() {
            if (isSpinning) return;
            SoundManager.init();
            isSpinning = true;
            emptyStateEl.classList.add('hidden');
            resultDisplayEl.classList.add('hidden'); 

            const count = activeData.outer.length;
            const degPerItem = 360 / count;
            const rand = Math.random();
            let targetOuterIndex = Math.floor(Math.random() * count);
            let targetInnerIndex = targetOuterIndex;

            if (rand > 0.8) {
                let offset = Math.floor(Math.random() * (count - 1)) + 1;
                targetInnerIndex = (targetOuterIndex + offset) % count;
            }

            const extraSpinsOuter = 5 + Math.floor(Math.random() * 2);
            const extraSpinsInner = 4 + Math.floor(Math.random() * 2);
            
            let distOuter = (360 * extraSpinsOuter) - (targetOuterIndex * degPerItem) - (outerRotation % 360);
            while(distOuter < 1080) distOuter += 360; 

            let distInner = (360 * extraSpinsInner) - (targetInnerIndex * degPerItem) - (innerRotation % 360);
            while(distInner < 1080) distInner += 360;

            outerRotation += distOuter;
            innerRotation += distInner;

            updateRotation();

            // éŸ³æ•ˆ
            let clicks = 0;
            const totalTime = 3500; // CSS transition time is 3.5s
            const intervalTime = 150; 
            spinInterval = setInterval(() => {
                if(clicks * intervalTime < totalTime - 600) {
                     SoundManager.playClick();
                }
                clicks++;
            }, intervalTime);

            setTimeout(() => {
                isSpinning = false;
                clearInterval(spinInterval);
                showResult(activeData.outer[targetOuterIndex], activeData.inner[targetInnerIndex]);
            }, totalTime);
        }

        function updateRotation() {
            outerRingEl.style.transform = `rotate(${outerRotation}deg)`;
            innerRingEl.style.transform = `rotate(${innerRotation}deg)`;
        }

        // --- è§¦æ§æ‰‹åŠ¿æ”¯æŒ ---
        const touchArea = document.getElementById('wheel-touch-area');
        let startY = 0;
        let isDragging = false;

        touchArea.addEventListener('touchstart', (e) => {
            if(isSpinning) return;
            startY = e.touches[0].clientY;
            isDragging = true;
        }, {passive: false}); // passive: false å…è®¸ preventDefault

        touchArea.addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            // å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›è·Ÿéšæ‰‹æŒ‡çš„è§†è§‰åé¦ˆï¼ˆå¯é€‰ï¼Œæš‚ç•¥ï¼‰
        }, {passive: false});

        touchArea.addEventListener('touchend', (e) => {
            if(!isDragging) return;
            const endY = e.changedTouches[0].clientY;
            const diff = startY - endY;
            
            // å¦‚æœæ»‘åŠ¨è·ç¦»è¶…è¿‡ 50pxï¼Œè§¦å‘æ—‹è½¬
            if (Math.abs(diff) > 50) {
                spin();
            }
            isDragging = false;
        });


        // --- 6. ç»“æœå±•ç¤º ---

        function showResult(part1, part2) {
            const key = `${part1}+${part2}`;
            const result = activeData.mapping[key];

            const errorDiv = document.getElementById('error-message');
            resultDisplayEl.classList.remove('hidden');

            document.getElementById('res-part1').innerText = part1;
            document.getElementById('res-part2').innerText = part2;

            if (result) {
                SoundManager.playWin();
                errorDiv.classList.add('hidden');
                document.getElementById('res-main-char').innerText = result.r;
                document.getElementById('res-pinyin').innerText = result.p;
                
                const wordsList = document.getElementById('res-words');
                wordsList.innerHTML = '';
                if (result.w && result.w.length > 0) {
                    result.w.forEach(word => {
                        const li = document.createElement('li');
                        li.className = "flex items-start bg-orange-50 p-2 rounded-lg mb-1 border border-orange-100";
                        li.innerHTML = `<span class="mr-2 text-orange-500 font-bold text-xs mt-1">â—</span> <span>${word}</span>`;
                        wordsList.appendChild(li);
                    });
                }
            } else {
                SoundManager.playFail();
                errorDiv.classList.remove('hidden');
                errorDiv.classList.remove('animate-fadeIn');
                void errorDiv.offsetWidth;
                errorDiv.classList.add('animate-fadeIn');
            }
        }

        function closeResult() {
            resultDisplayEl.classList.add('hidden');
            emptyStateEl.classList.remove('hidden');
        }

        // å¯åŠ¨
        initWheel();
        
        // ç›‘å¬çª—å£å¤§å°æ”¹å˜ï¼Œé‡ç»˜è½¬ç›˜æ–‡å­—ä½ç½®
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                renderRings(); // é‡æ–°è®¡ç®—åŠå¾„
            }, 100);
        });

    </script>
</body>
</html>
